!function(e,t){"function"==typeof define&&define.amd?define(["angular","ObjectPath","tv4"],t):"object"==typeof exports?module.exports=t(require("angular"),require("ObjectPath"),require("tv4")):e.schemaForm=t(e.angular,e.ObjectPath,e.tv4)}(this,function(e,t,r){var n=[];try{e.module("ngSanitize"),n.push("ngSanitize")}catch(i){}try{e.module("ui.sortable"),n.push("ui.sortable")}catch(i){}try{e.module("angularSpectrumColorpicker"),n.push("angularSpectrumColorpicker")}catch(i){}var a=e.module("schemaForm",n);return e.module("schemaForm").provider("sfPath",[function(){var r={parse:t.parse};1===e.version.major&&e.version.minor<3?r.stringify=function(e){return Array.isArray(e)?e.join("."):e.toString()}:r.stringify=t.stringify,r.normalize=function(e,t){return r.stringify(Array.isArray(e)?e:r.parse(e),t)},this.parse=r.parse,this.stringify=r.stringify,this.normalize=r.normalize,this.$get=function(){return r}}]),e.module("schemaForm").factory("sfSelect",["sfPath",function(e){var t=/^\d+$/;return function(r,n,i){n||(n=this);var a="string"==typeof r?e.parse(r):r;if("undefined"!=typeof i&&1===a.length)return n[a[0]]=i,n;"undefined"!=typeof i&&"undefined"==typeof n[a[0]]&&(n[a[0]]=a.length>2&&t.test(a[1])?[]:{});for(var o=n[a[0]],s=1;s<a.length;s++){if(""===a[s])return void 0;if("undefined"!=typeof i){if(s===a.length-1)return o[a[s]]=i,i;var l=o[a[s]];("undefined"==typeof l||null===l)&&(l=t.test(a[s+1])?[]:{},o[a[s]]=l),o=l}else o&&(o=o[a[s]])}return o}}]),e.module("schemaForm").provider("schemaFormDecorators",["$compileProvider","sfPathProvider",function(t,r){var n="",i={},a=function(e,t){"sfDecorator"===e&&(e=n);for(var r=i[e],a=r.rules,o=0;o<a.length;o++){var s=a[o](t);if(s)return s}return r.mappings[t.type]?r.mappings[t.type]:r.mappings["default"]},o=function(n){t.directive(n,["$parse","$compile","$http","$templateCache","$interpolate","$q","sfErrorMessage",function(t,i,o,s,l,u,c){return{restrict:"AE",replace:!1,transclude:!1,scope:!0,require:"?^sfSchema",link:function(t,f,m,d){t.$on("schemaFormPropagateNgModelController",function(e,r){e.stopPropagation(),e.preventDefault(),t.ngModel=r}),t.showTitle=function(){return t.form&&t.form.notitle!==!0&&t.form.title},t.listToCheckboxValues=function(t){var r={};return e.forEach(t,function(e){r[e]=!0}),r},t.checkboxValuesToList=function(t){var r=[];return e.forEach(t,function(e,t){e&&r.push(t)}),r},t.buttonClick=function(r,n){e.isFunction(n.onClick)?n.onClick(r,n):e.isString(n.onClick)&&(d?d.evalInParentScope(n.onClick,{$event:r,form:n}):t.$eval(n.onClick,{$event:r,form:n}))},t.evalExpr=function(e,r){return d?d.evalInParentScope(e,r):t.$eval(e,r)},t.evalInScope=function(e,r){return e?t.$eval(e,r):void 0},t.interp=function(e,t){return e&&l(e)(t)},t.hasSuccess=function(){return t.ngModel?t.ngModel.$valid&&(!t.ngModel.$pristine||!t.ngModel.$isEmpty(t.ngModel.$modelValue)):!1},t.hasError=function(){return t.ngModel?t.ngModel.$invalid&&!t.ngModel.$pristine:!1},t.errorMessage=function(e){return c.interpolate(e&&e.code+""||"default",t.ngModel&&t.ngModel.$modelValue||"",t.form,t.options&&t.options.validationMessage)};var h=t.$watch(m.form,function(l){if(l){l.ngModelOptions=l.ngModelOptions||{},t.form=l;var c;if("template"===l.type&&l.template)c=u.when(l.template);else{var m="template"===l.type?l.templateUrl:a(n,l);c=o.get(m,{cache:s}).then(function(e){return e.data})}c.then(function(n){if(l.key){var a=l.key?r.stringify(l.key).replace(/"/g,"&quot;"):"";n=n.replace(/\$\$value\$\$/g,"model"+("["!==a[0]?".":"")+a)}f.html(n),l.condition&&e.forEach(f.children(),function(e){var t=e.getAttribute("ng-if");e.setAttribute("ng-if",t?"("+t+') || (evalExpr(form.condition,{ model: model, "arrayIndex": arrayIndex }))':'evalExpr(form.condition,{ model: model, "arrayIndex": arrayIndex })')}),i(f.contents())(t)}),l.key&&t.$on("schemaForm.error."+l.key.join("."),function(e,r,n,i){(n===!0||n===!1)&&(i=n,n=void 0),t.ngModel&&r&&(t.ngModel.$setDirty()?t.ngModel.$setDirty():(t.ngModel.$dirty=!0,t.ngModel.$pristine=!1),n&&(l.validationMessage||(l.validationMessage={}),console.log("settings validationMessage",n),l.validationMessage[r]=n),t.ngModel.$setValidity(r,i===!0),i===!0&&t.$broadcast("schemaFormValidate"))}),h()}})}}}])},s=function(r,n,i){i=e.isDefined(i)?i:!1,t.directive("sf"+e.uppercase(r[0])+r.substr(1),function(){return{restrict:"EAC",scope:!0,replace:!0,transclude:i,template:'<sf-decorator form="form"></sf-decorator>',link:function(t,n,i){var a={items:"c",titleMap:"c",schema:"c"},o={type:r},s=!0;e.forEach(i,function(r,n){if("$"!==n[0]&&0!==n.indexOf("ng")&&"sfField"!==n){var l=function(r){e.isDefined(r)&&r!==o[n]&&(o[n]=r,s&&o.type&&(o.key||e.isUndefined(i.key))&&(t.form=o,s=!1))};"model"===n?t.$watch(r,function(e){e&&t.model!==e&&(t.model=e)}):"c"===a[n]?t.$watchCollection(r,l):i.$observe(n,l)}})}}})};this.createDecorator=function(e,t,r){i[e]={mappings:t||{},rules:r||[]},i[n]||(n=e),o(e)},this.createDirective=s,this.createDirectives=function(t){e.forEach(t,function(e,t){s(t,e)})},this.directive=function(e){return e=e||n,i[e]},this.addMapping=function(e,t,r){i[e]&&(i[e].mappings[t]=r)},this.$get=function(){return{directive:function(e){return i[e]},defaultDecorator:n}},o("sfDecorator")}]),e.module("schemaForm").provider("sfErrorMessage",function(){var t={"default":"Field does not validate",0:"Invalid type, expected {{schema.type}})",1:"No enum match for: {{value}}",10:'Data does not match any schemas from "anyOf"',11:'Data does not match any schemas from "oneOf"',12:'Data is valid against more than one schema from "oneOf"',13:'Data matches schema from "not"',100:"Value {{value}} is not a multiple of {{schema.multipleOf}}",101:"Value {{value}} is less than minimum {{schema.minimum}}",102:"Value {{value}} is equal to exclusive minimum {{schema.minimum}}",103:"Value {{value}} is greater than maximum {{schema.maximum}}",104:"Value {{value}} is equal to exclusive maximum {{schema.maximum}}",105:"Value {{value}} is not a valid number",200:"String is too short ({{value.length}} chars), minimum {{schema.minimum}}",201:"String is too long ({{value.length}} chars), maximum {{schema.maximum}}",202:"String does not match pattern: {{schema.pattern}}",300:"Too few properties defined, minimum {{schema.minimum}}",301:"Too many properties defined, maximum {{schema.maximum}}",302:"Required",303:"Additional properties not allowed",304:"Dependency failed - key must exist",400:"Array is too short ({{value.length}}), minimum {{schema.minimum}}",401:"Array is too long ({{value.length}}), maximum {{schema.maximum}}",402:"Array items are not unique",403:"Additional items not allowed",500:"Format validation failed",501:'Keyword failed: "{{title}}"',600:"Circular $refs",1e3:"Unknown property (not in schema)"};this.setDefaultMessages=function(e){t=e},this.getDefaultMessages=function(){return t},this.setDefaultMessage=function(e,r){t[e]=r},this.$get=["$interpolate",function(r){var n={};return n.defaultMessages=t,n.interpolate=function(n,i,a,o){o=o||{};var s=a.validationMessage||{};0===n.indexOf("tv4-")&&(n=n.substring(4));var l=s["default"]||o["default"]||"";[s,o,t].some(function(t){return e.isString(t)||e.isFunction(t)?(l=t,!0):t&&t[n]?(l=t[n],!0):void 0});var u={error:n,value:i,form:a,schema:a.schema,title:a.title||a.schema&&a.schema.title};return e.isFunction(l)?l(u):r(l)(u)},n}]}),e.module("schemaForm").provider("schemaForm",["sfPathProvider",function(t){var r=function(e){if(Array.isArray(e)&&2==e.length){if("null"===e[0])return e[1];if("null"===e[1])return e[0]}return e},n=function(e){var t=[];return e.forEach(function(e){t.push({name:e,value:e})}),t},i=function(t,r){if(!e.isArray(t)){var n=[];return r?e.forEach(r,function(e,r){n.push({name:t[e],value:e})}):e.forEach(t,function(e,t){n.push({name:e,value:t})}),n}return t},a=function(t,n,i){var a=p[r(n.type)];if(a)for(var o,s=0;s<a.length;s++)if(o=a[s](t,n,i))return o.schema["x-schema-form"]&&e.isObject(o.schema["x-schema-form"])&&(o=e.extend(o,o.schema["x-schema-form"])),o},o=function(t,r,n){n=n||{};var a=n.global&&n.global.formDefaults?e.copy(n.global.formDefaults):{};return n.global&&n.global.supressPropertyTitles===!0?a.title=r.title:a.title=r.title||t,r.description&&(a.description=r.description),(n.required===!0||r.required===!0)&&(a.required=!0),r.maxLength&&(a.maxlength=r.maxLength),r.minLength&&(a.minlength=r.maxLength),(r.readOnly||r.readonly)&&(a.readonly=!0),r.minimum&&(a.minimum=r.minimum+(r.exclusiveMinimum?1:0)),r.maximum&&(a.maximum=r.maximum-(r.exclusiveMaximum?1:0)),r.validationMessage&&(a.validationMessage=r.validationMessage),r.enumNames&&(a.titleMap=i(r.enumNames,r["enum"])),a.schema=r,a.ngModelOptions=a.ngModelOptions||{},a},s=function(e,n,i){if("string"===r(n.type)&&!n["enum"]){var a=o(e,n,i);return a.key=i.path,a.type="text",i.lookup[t.stringify(i.path)]=a,a}},l=function(e,n,i){if("number"===r(n.type)){var a=o(e,n,i);return a.key=i.path,a.type="number",i.lookup[t.stringify(i.path)]=a,a}},u=function(e,n,i){if("integer"===r(n.type)){var a=o(e,n,i);return a.key=i.path,a.type="number",i.lookup[t.stringify(i.path)]=a,a}},c=function(e,n,i){if("boolean"===r(n.type)){var a=o(e,n,i);return a.key=i.path,a.type="checkbox",i.lookup[t.stringify(i.path)]=a,a}},f=function(e,i,a){if("string"===r(i.type)&&i["enum"]){var s=o(e,i,a);return s.key=a.path,s.type="select",s.titleMap||(s.titleMap=n(i["enum"])),a.lookup[t.stringify(a.path)]=s,s}},m=function(e,i,a){if("array"===r(i.type)&&i.items&&i.items["enum"]){var s=o(e,i,a);return s.key=a.path,s.type="checkboxes",s.titleMap||(s.titleMap=n(i.items["enum"])),a.lookup[t.stringify(a.path)]=s,s}},d=function(n,i,s){if("object"===r(i.type)){var l=o(n,i,s);return l.type="fieldset",l.items=[],s.lookup[t.stringify(s.path)]=l,e.forEach(i.properties,function(e,r){var n=s.path.slice();if(n.push(r),s.ignore[t.stringify(n)]!==!0){var o=i.required&&-1!==i.required.indexOf(r),u=a(r,e,{path:n,required:o||!1,lookup:s.lookup,ignore:s.ignore});u&&l.items.push(u)}}),l}},h=function(e,n,i){if("array"===r(n.type)){var s=o(e,n,i);s.type="array",s.key=i.path,i.lookup[t.stringify(i.path)]=s;var l=n.required&&-1!==n.required.indexOf(i.path[i.path.length-1]),u=i.path.slice();return u.push(""),s.items=[a(e,n.items,{path:u,required:l||!1,lookup:i.lookup,ignore:i.ignore,global:i.global})],s}},p={string:[f,s],object:[d],number:[l],integer:[u],"boolean":[c],array:[m,h]},v=function(e){return e};this.defaults=p,this.stdFormObj=o,this.defaultFormDefinition=a,this.postProcess=function(e){v=e},this.appendRule=function(e,t){p[e]||(p[e]=[]),p[e].push(t)},this.prependRule=function(e,t){p[e]||(p[e]=[]),p[e].unshift(t)},this.createStandardForm=o,this.$get=function(){var n={};return n.merge=function(r,a,o,s,l){a=a||["*"],s=s||{},l=l||r.readonly||r.readOnly;var u=n.defaults(r,o,s),c=a.indexOf("*");-1!==c&&(a=a.slice(0,c).concat(u.form).concat(a.slice(c+1)));var f=u.lookup;return v(a.map(function(a){if("string"==typeof a&&(a={key:a}),a.key&&"string"==typeof a.key&&(a.key=t.parse(a.key)),a.titleMap&&(a.titleMap=i(a.titleMap)),a.itemForm){a.items=[];var u=t.stringify(a.key),c=f[u];e.forEach(c.items,function(t){var r=e.copy(a.itemForm);r.key=t.key,a.items.push(r)})}if(a.key){var m=t.stringify(a.key);if(f[m]){var d=f[m];e.forEach(d,function(e,t){void 0===a[t]&&(a[t]=d[t])})}}return l===!0&&(a.readonly=!0),a.items&&(a.items=n.merge(r,a.items,o,s,a.readonly)),a.tabs&&e.forEach(a.tabs,function(e){e.items=n.merge(r,e.items,o,s,a.readonly)}),"checkbox"===a.type&&e.isUndefined(a.schema["default"])&&(a.schema["default"]=!1),a}))},n.defaults=function(t,n,i){var o=[],s={};if(n=n||{},i=i||{},"object"!==r(t.type))throw new Error('Not implemented. Only type "object" allowed at root level of schema.');return e.forEach(t.properties,function(e,r){if(n[r]!==!0){var l=t.required&&-1!==t.required.indexOf(r),u=a(r,e,{path:[r],lookup:s,ignore:n,required:l,global:i});u&&o.push(u)}}),{form:o,lookup:s}},n.traverseSchema=function(t,r,n,i){i=e.isDefined(i)?i:!0,n=n||[];var a=function(t,r,n){if(r(t,n),e.forEach(t.properties,function(e,t){var i=n.slice();i.push(t),a(e,r,i)}),!i&&t.items){var o=n.slice();o.push(""),a(t.items,r,o)}};a(t,r,n||[])},n.traverseForm=function(t,r){r(t),e.forEach(t.items,function(e){n.traverseForm(e,r)}),t.tabs&&e.forEach(t.tabs,function(t){e.forEach(t.items,function(e){n.traverseForm(e,r)})})},n}}]),e.module("schemaForm").factory("sfValidator",[function(){var t={};return t.validate=function(t,n){if(!t)return{valid:!0};var i=t.schema;if(!i)return{valid:!0};""===n&&(n=void 0),"number"===t.type&&null===n&&(n=void 0);var a={type:"object",properties:{}},o=t.key[t.key.length-1];a.properties[o]=i,t.required&&(a.required=[o]);var s={};return e.isDefined(n)&&(s[o]=n),r.validateResult(s,a)},t}]),e.module("schemaForm").directive("sfArray",["sfSelect","schemaForm","sfValidator","sfPath",function(t,r,n,i){var a=function(e){return function(t){t.key&&(t.key[t.key.indexOf("")]=e)}};return{restrict:"A",scope:!0,require:"?ngModel",link:function(o,s,l,u){var c={};u&&o.$emit("schemaFormPropagateNgModelController",u);var f=o.$watch(l.sfArray,function(s){var l=t(s.key,o.model);if(o.$watch("model"+i.normalize(s.key),function(){l=t(s.key,o.model),o.modelArray=l}),e.isUndefined(l)&&(l=[],t(s.key,o.model,l)),o.modelArray=l,s.items){var m=s.items[0];s.items.length>1&&(m={type:"section",items:s.items.map(function(t){return t.ngModelOptions=s.ngModelOptions,e.isUndefined(t.readonly)&&(t.readonly=s.readonly),t})})}if(o.copyWithIndex=function(t){if(!c[t]&&m){var n=e.copy(m);n.arrayIndex=t,r.traverseForm(n,a(t)),c[t]=n}return c[t]},o.appendToArray=function(){var n=l.length,i=o.copyWithIndex(n);if(r.traverseForm(i,function(r){if(r.key){var n;e.isDefined(r["default"])&&(n=r["default"]),e.isDefined(r.schema)&&e.isDefined(r.schema["default"])&&(n=r.schema["default"]),e.isDefined(n)&&t(r.key,o.model,n)}}),n===l.length){var a,u=t("schema.items.type",s);"object"===u?a={}:"array"===u&&(a=[]),l.push(a)}return o.validateArray&&o.validateArray(),l},o.deleteFromArray=function(e){return l.splice(e,1),o.validateArray&&o.validateArray(),u&&u.$setDirty&&u.$setDirty(),l},s.titleMap||s.startEmpty===!0||0!==l.length||o.appendToArray(),s.titleMap&&s.titleMap.length>0){o.titleMapValues=[];var d=function(e){o.titleMapValues=[],e=e||[],s.titleMap.forEach(function(t){o.titleMapValues.push(-1!==e.indexOf(t.value))})};d(o.modelArray),o.$watchCollection("modelArray",d),o.$watchCollection("titleMapValues",function(e){if(e){for(var t=o.modelArray;t.length>0;)t.pop();s.titleMap.forEach(function(r,n){e[n]&&t.push(r.value)})}})}if(u){var h;o.validateArray=function(){var e=n.validate(s,o.modelArray.length>0?o.modelArray:void 0);Object.keys(u.$error).filter(function(e){return 0===e.indexOf("tv4-")}).forEach(function(e){u.$setValidity(e,!0)}),e.valid!==!1||!e.error||""!==e.error.dataPath&&e.error.dataPath!=="/"+s.key[s.key.length-1]||(u.$setViewValue(o.modelArray),h=e.error,u.$setValidity("tv4-"+e.error.code,!1))},o.$on("schemaFormValidate",o.validateArray),o.hasSuccess=function(){return u.$valid&&!u.$pristine},o.hasError=function(){return u.$invalid},o.schemaError=function(){return h}}f()})}}}]),e.module("schemaForm").directive("sfChanged",function(){return{require:"ngModel",restrict:"AC",scope:!1,link:function(t,r,n,i){var a=t.$eval(n.sfChanged);a&&a.onChange&&i.$viewChangeListeners.push(function(){e.isFunction(a.onChange)?a.onChange(i.$modelValue,a):t.evalExpr(a.onChange,{modelValue:i.$modelValue,form:a})})}}}),e.module("schemaForm").directive("sfMessage",["$injector","sfErrorMessage",function(e,t){return{scope:!1,restrict:"EA",link:function(r,n,i){var a=e.has("$sanitize")?e.get("$sanitize"):function(e){return e},o="";i.sfMessage&&(o=r.$eval(i.sfMessage)||"",o=a(o));var s=function(e){if(e&&r.hasError())n.html(o);else{var i=Object.keys(r.ngModel&&r.ngModel.$error||{}),a=i[0];i.length>1&&(a=i.reduce(function(e,t){return e&&0===e.indexOf("tv4-")?e:t}),console.log("reduced",i,a)),n.html(a?t.interpolate(a,r.ngModel.$modelValue,r.form,r.options&&r.options.validationMessage):o)}};s(),r.$watchCollection("ngModel.$error",function(){r.ngModel&&s(r.ngModel.$valid)})}}}]),e.module("schemaForm").directive("sfSchema",["$compile","schemaForm","schemaFormDecorators","sfSelect","sfPath",function(t,r,n,i,a){var o=/[A-Z]/g,s=function(e,t){return t=t||"_",e.replace(o,function(e,r){return(r?t:"")+e.toLowerCase()})};return{scope:{schema:"=sfSchema",initialForm:"=sfForm",model:"=sfModel",options:"=sfOptions"},controller:["$scope",function(e){this.evalInParentScope=function(t,r){return e.$parent.$eval(t,r)}}],replace:!1,restrict:"A",transclude:!0,require:"?form",link:function(o,l,u,c,f){o.formCtrl=c;var m={};f(o,function(e){if(e.addClass("schema-form-ignore"),l.prepend(e),l[0].querySelectorAll){var t=l[0].querySelectorAll("[ng-model]");if(t)for(var r=0;r<t.length;r++){var n=t[r].getAttribute("ng-model");m[n.substring(n.indexOf(".")+1)]=!0}}});var d,h={},p=function(c,f){var h=r.merge(c,f,m,o.options),p=document.createDocumentFragment();d&&d.$destroy(),d=o.$new(),d.schemaForm={form:h,schema:c},l.children(":not(.schema-form-ignore)").remove();for(var v={},y=l[0].querySelectorAll("*[sf-insert-field]"),g=0;g<y.length;g++)v[y[g].getAttribute("sf-insert-field")]=y[g];e.forEach(h,function(e,t){var r=document.createElement(u.sfUseDecorator||s(n.defaultDecorator,"-"));if(r.setAttribute("form","schemaForm.form["+t+"]"),e.key){var i=v[a.stringify(e.key)];if(i){for(;i.firstChild;)i.removeChild(i.firstChild);return void i.appendChild(r)}}p.appendChild(r)}),l[0].appendChild(p),t(l.children())(d),r.traverseSchema(c,function(t,r){if(e.isDefined(t["default"])){var n=i(r,o.model);e.isUndefined(n)&&i(r,o.model,t["default"])}}),o.$emit("sf-render-finished",l)};o.$watch(function(){var e=o.schema,t=o.initialForm||["*"];t&&e&&e.type&&(h.form!==t||h.schema!==e)&&Object.keys(e.properties).length>0&&(h.schema=e,h.form=t,p(e,t))}),o.$on("schemaFormRedraw",function(){var e=o.schema,t=o.initialForm||["*"];e&&p(e,t)})}}}]),e.module("schemaForm").directive("schemaValidate",["sfValidator","sfSelect",function(t,r){return{restrict:"A",scope:!1,priority:500,require:"ngModel",link:function(n,i,a,o){n.$emit("schemaFormPropagateNgModelController",o);var s=null,l=function(){return u||(u=n.$eval(a.schemaValidate)),u},u=l();u.copyValueTo&&o.$viewChangeListeners.push(function(){var t=u.copyValueTo;e.forEach(t,function(e){r(e,n.model,o.$modelValue)})});var c=function(e){if(u=l(),!u)return e;if(n.options&&n.options.tv4Validation===!1)return e;var r=t.validate(u,e);return Object.keys(o.$error).filter(function(e){return 0===e.indexOf("tv4-")}).forEach(function(e){o.$setValidity(e,!0)}),r.valid?e:(o.$setValidity("tv4-"+r.error.code,!1),void(s=r.error))};"function"==typeof u.ngModel&&u.ngModel(o),["$parsers","$viewChangeListeners","$formatters"].forEach(function(e){u[e]&&o[e]&&u[e].forEach(function(t){o[e].push(t)})}),["$validators","$asyncValidators"].forEach(function(t){u[t]&&o[t]&&e.forEach(u[t],function(e,r){o[t][r]=e})}),o.$parsers.push(c),n.$on("schemaFormValidate",function(){o.$setDirty?(o.$setDirty(),c(o.$modelValue)):o.$setViewValue(o.$viewValue)}),n.schemaError=function(){return s}}}}]),a});